<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SuperI/O——风扇控制</title>
      <link href="/2022/04/16/SuperI-O%E2%80%94%E2%80%94%E9%A3%8E%E6%89%87%E6%8E%A7%E5%88%B6/"/>
      <url>/2022/04/16/SuperI-O%E2%80%94%E2%80%94%E9%A3%8E%E6%89%87%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">            <i class="fa fa-quote-left"></i>            <p>Super I&#x2F;O修改风扇转速 </p>            <i class="fa fa-quote-right"></i>          </blockquote><h1 id="Super-I-x2F-O——风扇控制"><a href="#Super-I-x2F-O——风扇控制" class="headerlink" title="Super I&#x2F;O——风扇控制"></a>Super I&#x2F;O——风扇控制</h1><p>风扇控制主要是通过对<code>Super I/O</code>的相应寄存器进行读写操作实现的。</p><span id="more"></span><p>按照惯例，先来一段概念解释：</p><p>“<code>Super I/O</code>芯片也叫<code>I/O</code>芯片。在486以上档次的主板上都有<code>I/O</code>控制电路。因为在南桥这样的高速设备和串行、并行接口、软盘驱动器及键盘鼠标等大量低速设备之间必定存在资源的不匹配，而需要经过转换和管理。而<code>Super I/O</code>芯片则完成了该功能。</p><p>通常在硬件监控芯片中会整合超级<code>I/O</code>功能，可用于监控受监控对象的电压、温度、转速等。主板在附件中会提供某种软件，它和主板上的硬件配合使用就能实现对电压、温度、风扇转速等的监控，一旦检测到这些参数超出设定的指标时，它会自动作出调整，以保护元件的安全。常见的温度控制芯片有<code>ADT7463</code>等等；通用的通用硬件监控芯片有<code>Winbond</code>的<code>W83697HF</code>和<code>W83627HF</code>，<code>SMSC</code>的<code>LPC47M172</code>，<code>ITE</code>的<code>IT8705F</code>、<code>IT8703F</code>，<code>ASUS</code>的<code>AS99172F</code>等等，这些芯片通常还整合了对于温度的监控需与温度传感元件配合；对风扇电机转速的监控，则需与<code>CPU</code>的散热风扇配合使用。”</p><p align="right">——引用自百度百科</p><p>在<code>Spec</code>中，给出了完成配置设置的三个步骤：</p><ol><li>进入<code>MB PnP</code>模式</li><li>修改配置寄存器中的数据</li><li>退出<code>MB PnP</code>模式</li></ol><h2 id="进入MB-PnP模式"><a href="#进入MB-PnP模式" class="headerlink" title="进入MB PnP模式"></a>进入<code>MB PnP</code>模式</h2><p>要进入<code>MB PnP</code>模式，需要对两个特殊端口连续写入几个特殊值，这里有一张表：<br><img src="/2022-04-16-16-07-23.png"></p><p align="center">图1.1 MB PnP Mode Port</p><p>这张表中，给出了两组地址&#x2F;数据端口，<code>2Eh/2Fh</code>和<code>4Eh/4Fh</code>。<br>连续向地址端口写入特殊值即可进入<code>MB PnP</code>模式，如向<code>2Eh-&gt;00h</code>连续写入<code>87h,01h,55h,55h</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_CONFIG_ADDRESS 0x2E</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIO_CONFIG_DATA 0x2F</span></span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x87</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x01</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x55</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x55</span>);</span><br></pre></td></tr></table></figure><p><img src="/2022-04-16-17-11-24.png"></p><p align="center">图1.2 MB PnP Mode</p><h2 id="修改配置寄存器中的数据"><a href="#修改配置寄存器中的数据" class="headerlink" title="修改配置寄存器中的数据"></a>修改配置寄存器中的数据</h2><p>进入<code>MB PnP</code>模式后，可以访问所有配置寄存器。<br>在访问要修改的寄存器（除了一些全局寄存器）之前，索引<code>07h</code>必须更改为寄存器所属的<code>LDN(Logic Device Number)</code>。<br>查看<code>Spec</code>，找到<code>EC</code>（环境控制寄存器）的<code>LDN</code>:<br><img src="/2022-04-16-16-56-37.png"></p><p align="center">图2.1 EC配置寄存器表</p><p>修改索引<code>07h</code>为<code>04h</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x07</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_DATA, <span class="number">0x04</span>);</span><br></pre></td></tr></table></figure><p><img src="/2022-04-16-17-12-12.png"></p><p align="center">图2.2 RW查看EC配置寄存器</p><h3 id="使能EC"><a href="#使能EC" class="headerlink" title="使能EC"></a>使能EC</h3><p><img src="/2022-04-16-17-09-22.png"></p><p align="center">图2.3 EC触发寄存器</p><p>需要确保索引<code>30h</code>为<code>1</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x30</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_DATA, <span class="number">0x01</span>);</span><br></pre></td></tr></table></figure><h3 id="获取EC基地址"><a href="#获取EC基地址" class="headerlink" title="获取EC基地址"></a>获取EC基地址</h3><p><code>EC</code>基地址需要读取两个寄存器的值进行拼接计算<br><img src="/2022-04-16-17-15-06.png"></p><p align="center">图2.3 EC基地址寄存器</p><p>索引<code>60h</code>获取高八位，索引<code>61h</code>获取低八位，拼接后就可以得到基地址<br>根据<strong>图2.2</strong>，索引<code>60h</code>值为<code>0Ah</code>，即<code>0000 1010</code>，高四位为恒为0作为基地址的15-12位，低四位作为基地址11-8位<br>索引<code>61h</code>值为<code>20h</code>，即<code>0010 0000</code>，高五位作为基地址的7-3位，低三位恒为零作为基地址的2-0位<br>拼接得到<code>EC</code>基地址为：<code>A20h</code></p><p><img src="/2022-04-18-08-46-19.png"></p><p align="center">图2.4 LCPC总线地址映射</p><p>最后加5得到EC地址寄存器地址，加6得到EC数据寄存器地址<br><code>EC</code>地址寄存器地址：<code>A25h</code><br><code>EC</code>数据寄存器地址：<code>A26h</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DWORD MSB, LSB, EC_BaseAddress, EC_Address, EC_Data;</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x60</span>);</span><br><span class="line"><span class="built_in">GetPortVal</span>(SIO_CONFIG_DATA, &amp;MSB);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x61</span>);</span><br><span class="line"><span class="built_in">GetPortVal</span>(SIO_CONFIG_DATA, &amp;LSB);</span><br><span class="line">EC_BaseAddress = (MSB &lt;&lt; <span class="number">8</span>) | LSB;</span><br><span class="line">EC_Address = EC_BaseAddress + <span class="number">0x05</span>;</span><br><span class="line">EC_Data = EC_BaseAddress + <span class="number">0x06</span>;</span><br></pre></td></tr></table></figure><p><code>Spec</code>中有一张表格列出了环境控制器中的寄存器，我们找到风扇的部分<br><img src="/2022-04-18-08-57-12.png"></p><p align="center">图2.5 Environment Controller Registers(Part 1)</p><p><img src="/2022-04-18-09-01-07.png"></p><p align="center">图2.6 Environment Controller Registers(Part 2)</p><p>把这些寄存器的含义都浏览一遍，控制风扇基本就没什么问题了。</p><h3 id="修改风扇转速"><a href="#修改风扇转速" class="headerlink" title="修改风扇转速"></a>修改风扇转速</h3><p>我将修改风扇转速分成四步，以系统风扇为例</p><ol><li>输出模式选择风扇智能控制模式</li><li>启用软件控制模式</li><li>将风扇转速百分百转换格式</li><li>写入转速百分比</li></ol><h4 id="风扇智能控制模式"><a href="#风扇智能控制模式" class="headerlink" title="风扇智能控制模式"></a>风扇智能控制模式</h4><p><img src="/2022-04-18-09-35-49.png"></p><p align="center">图2.7 风扇控制器主控制寄存器</p><p>将与风扇对应的<code>bit</code>置1，也可以直接将2-0位都置为1</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(EC_Address, <span class="number">0x13</span>);</span><br><span class="line"><span class="built_in">GetPortVal</span>(EC_Data, &amp;temp);</span><br><span class="line">temp = temp | <span class="number">0x7</span>;</span><br><span class="line"><span class="built_in">SetPortVal</span>(EC_Data, temp);</span><br></pre></td></tr></table></figure><h4 id="软件控制模式"><a href="#软件控制模式" class="headerlink" title="软件控制模式"></a>软件控制模式</h4><p><img src="/2022-04-18-09-41-26.png"></p><p align="center">图2.8 风扇PWM控制寄存器</p><p>将<code>bit7</code>置0，以<code>FAN_CTL1</code>为例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(EC_Address, <span class="number">0x15</span>);</span><br><span class="line"><span class="built_in">GetPortVal</span>(EC_Data, &amp;temp);</span><br><span class="line">temp = temp &amp; <span class="number">0x7F</span>;</span><br><span class="line"><span class="built_in">SetPortVal</span>(EC_Data, temp);</span><br></pre></td></tr></table></figure><h4 id="转换格式"><a href="#转换格式" class="headerlink" title="转换格式"></a>转换格式</h4><p>在<code>EC</code>控制器中，百分比并不是<code>0-100</code>，而是<code>0-255</code>。<br>因此，我们需要将我们要设置的百分比进行转化，假设我们要设置转速为<code>80%</code>：<br><code>Rate = (80 * 255) / 100;</code><br>得到的结果是<code>204</code>，转换成<code>16</code>进制就是<code>CCh</code></p><h4 id="设置风扇转速百分比"><a href="#设置风扇转速百分比" class="headerlink" title="设置风扇转速百分比"></a>设置风扇转速百分比</h4><p><img src="/2022-04-18-09-24-12.png"></p><p align="center">图2.9 智能卫士自动模式启动 PWM 寄存器</p><p>该寄存器的值就是风扇实时转速百分比</p><p>还是以<code>FAN_CTL1</code>为例，它对应的寄存器是<code>63h</code>，将我们转换的转速百分比写入寄存器</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(EC_Address, <span class="number">0x63</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(EC_Data, Rate);</span><br></pre></td></tr></table></figure><p>如果前面的步骤都没有出错的话，那么此时风扇转速应该会随着改变。<br>但是，风扇转速会渐渐复位，至于如何使风扇转速恒定，下次再写吧……</p><h2 id="退出MB-PnP模式"><a href="#退出MB-PnP模式" class="headerlink" title="退出MB PnP模式"></a>退出<code>MB PnP</code>模式</h2><p>向特殊端口<code>2Eh</code>或<code>4Eh</code>的<code>02h</code>写入<code>02h</code>即可退出<code>MB PnP</code>模式</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_ADDRESS, <span class="number">0x02</span>);</span><br><span class="line"><span class="built_in">SetPortVal</span>(SIO_CONFIG_DATA, <span class="number">0x02</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SuperI/O </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SuperI/O </tag>
            
            <tag> 风扇 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>序</title>
      <link href="/2022/04/11/%E5%BA%8F/"/>
      <url>/2022/04/11/%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<blockquote class="blockquote-center">            <i class="fa fa-quote-left"></i>            <p>你要做一个不动声色的大人了。</P><p>去过自己另外的生活。</P><p>不准情绪化，不准偷偷想念，不准回头看。</P><p>你要听话，不是所有的鱼都会生活在同一片海里。</P>            <i class="fa fa-quote-right"></i>          </blockquote>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
